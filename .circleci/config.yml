version: 2.1
commands:
  install-bazel:
    steps:
      - run:
          name: Install bazel
          command: |
            curl -OL https://github.com/bazelbuild/bazel/releases/download/$BAZEL_VER/bazel-$BAZEL_VER-installer-linux-x86_64.sh
            chmod +x bazel-$BAZEL_VER-installer-linux-x86_64.sh
            sudo ./bazel-$BAZEL_VER-installer-linux-x86_64.sh
            rm ./bazel-$BAZEL_VER-installer-linux-x86_64.sh
            bazel info release

  pre-run-setup:
    steps:
      - run:
          name: Prepare to run bazel
          command: |
            sudo apt-get update -q
            sudo apt-get install libxml2-utils python-dev -y # Install some basics needed for python
            cat .bazelrc.travis >> .bazelrc

  bazel-build:
    steps:
      - run:
          name: Build with bazel
          command: |
            bazel build //...

  bazel-test:
    steps:
      - run:
          name: Test with bazel
          command: |
            bazel test //...

  e2e-test:
    steps:
      - run:
          name: End to end tests
          command: |
            ./test_e2e.sh

  restore-caches:
    steps:
      - run: echo "$BAZEL_VER" > _cache_ver_tmp
      - restore_cache:
          keys:
            - bazel_cache_{{ checksum "_cache_ver_tmp" }}

  save-caches:
    steps:
      - run: echo "$BAZEL_VER" > _cache_ver_tmp
      - save_cache:
          key: bazel_cache_{{ checksum "_cache_ver_tmp" }}
          paths:
            - "/home/circleci/.cache/bazel/"

jobs:
  build-template: &build-template
    docker:
      - image: circleci/openjdk:8
    working_directory: ~/app/
    environment:
      BAZEL_VER: "override_this"
    steps:
      - setup_remote_docker:
          docker_layer_caching: true
      - checkout
      - pre-run-setup
      - install-bazel
      - restore-caches
      - bazel-build
      - bazel-test
      - save-caches
      # - e2e-test - Leave this out for now until docker issues can be resolved

  build-bazel-019:
    <<: *build-template
    environment:
      BAZEL_VER: "0.19.2"
  build-bazel-022:
    <<: *build-template
    environment:
      BAZEL_VER: "0.22.0"
  build-bazel-023:
    <<: *build-template
    environment:
      BAZEL_VER: "0.23.2"
  build-bazel-024:
    <<: *build-template
    environment:
      BAZEL_VER: "0.24.1"
  build-bazel-025:
    <<: *build-template
    environment:
      BAZEL_VER: "0.25.3"
  build-bazel-026:
    <<: *build-template
    environment:
      BAZEL_VER: "0.26.1"
  build-bazel-027:
    <<: *build-template
    environment:
      BAZEL_VER: "0.27.1"

workflows:
  version: 2
  default_workflow:
    jobs:
      # Commented out means the version does not work
      # - build-bazel-019
      # - build-bazel-022
      # - build-bazel-023
      # - build-bazel-024
      - build-bazel-025
      - build-bazel-026
      # - build-bazel-027